let search_timer=null;function live_search(e){let r=$("#collapse_search .list-group");r.find("a.list-group-item-action").remove(),$("#heading_search .badge.badge-primary").text("0"),e=e.toLowerCase();let t=0;$("a.list-group-item-action").each((function(){-1!=$(this).text().toLowerCase().indexOf(""+e)&&($(this).clone().appendTo(r),t++)})),$("#heading_search .badge.badge-primary").text(t),init_stream_actions()}function set_bouquets_height(){let e=$("#bouquets").position(),r=$(window).height()-($("#bouquets .card-header:first").outerHeight()*$("#bouquets .card-header").length+e.top)-100;$("div.card-body").height(r)}function show_epg(e){let r=$('a[data-type="channel"][data-id="'+e+'"]'),t=$("#dreamboxModal");t.find(".modal-dialog").addClass("modal-xl"),t.find(".modal-title").html("Electronic program guide "+r.find("h5").html()),t.find(".modal-body img").parent().hide(),t.find(".stream-info").removeClass("col-8").html('<h3 class="text-center">Loading EPG data ...</h3>'),t.modal(),$.get("/dreambox/"+dreambox_id+"/channel/"+e+"/epg",(function(e){t.find(".modal-header .clearfix").hide(),t.find(".modal-header img").attr({src:r.css("background-image").replace('url("',"").replace('")',"")}).show(),t.find(".stream-info").html(Autolinker.link(e)),t.find(".stream-info .list-group-item-action:first").addClass("active"),t.find(".program-start").each((function(e,r){$(r).text(moment(+moment.utc($(r).text())).format("dddd D MMMM @ LT"))})),t.find(".program-stop").each((function(e,r){$(r).text(moment(+moment.utc($(r).text())).format("LT"))})),t.find(".program-duration").each((function(e,r){$(r).text(moment.duration(1*$(r).text(),"seconds").humanize())}))}))}function init_stream_actions(){$("a.list-group-item-action").off("click").on("click",(function(e){return stream($(this).attr("data-id"),$(this).attr("data-type")),!1})),$("button.epg").off("click").on("click",(function(e){return show_epg($(this).attr("data-channel")),!1}))}function generate_player_title_overlay(){let e=$("h3:first").text();return dreambox_player.source&&"channel"==dreambox_player.source.type?e=$("<div/>").html(dreambox_player.source.name).text()+" - now: "+$("<div/>").html(dreambox_player.source.currentprogram.name).text()+" ("+moment.duration(moment(+moment.utc(dreambox_player.source.nextprogram.start))-moment.now()).humanize()+" left). next: "+$("<div/>").html(dreambox_player.source.nextprogram.name).text():dreambox_player.source&&"recording"==dreambox_player.source.type&&(e="Recording: "+$("<div/>").html(dreambox_player.source.name).text()+" (duration "+moment.duration(dreambox_player.source.duration,"seconds").humanize()+", recored at: "+moment(+moment.utc(dreambox_player.source.start)).format("LLLL")+")"),e}function stream(e,r){dreambox_player.pause();let t=$('a[data-type="'+r+'"][data-id="'+e+'"]'),a=$("#dreamboxModal");a.find(".modal-dialog").removeClass("modal-xl"),a.find(".modal-header img").hide(),a.find(".modal-header .clearfix").show(),a.find(".modal-title").html("Loading..."),a.find(".stream-info").addClass("col-8").html(""),t.length>=1&&(a.find(".modal-body img").attr({src:$(t[0]).css("background-image").replace('url("',"").replace('")',"")}).parent().show(),a.find(".stream-info").html($(t[0]).html()),a.modal({keyboard:!1})),$("a.list-group-item-action").removeClass("active"),$.post("/api/dreambox/"+dreambox_id+"/"+r+"/"+e+"/stream",(function(e){$(".test-screen").remove(),$(document).scrollTop(0);let r=t.parents("div.card");r.find(".collapse").hasClass("show")||r.find(".card-header").trigger("click"),t.addClass("active");let a=t.position();r.find(".card-body").scrollTop(r.find(".card-body").scrollTop()+(a.top-t.height())),dreambox_player.source=e,dreambox_player.src({type:"application/x-mpegURL",src:dreambox_player.source.stream}),dreambox_player.play(),update_current_source()}))}function update_current_source(){dreambox_player.source&&("channel"==dreambox_player.source.type?update_current_program():"recording"==dreambox_player.source.type&&update_current_recording(),start_progress_bar())}function update_current_program(){if(!dreambox_player.source)return;let e=$("div.program-info");e.find("h5 span").html(dreambox_player.source.currentprogram.name),e.find("p").html(Autolinker.link(dreambox_player.source.currentprogram.description)),e.find("small.program-now").text("("+moment.duration(dreambox_player.source.currentprogram.duration,"seconds").humanize()+")"),e.find("small.program-next").html("next: "+moment(+moment.utc(dreambox_player.source.nextprogram.start)).format("LT")+" - "+dreambox_player.source.nextprogram.name+" ("+moment.duration(dreambox_player.source.nextprogram.duration,"seconds").humanize()+")"),dreambox_player.source.picon&&e.find("img").attr({src:dreambox_player.source.picon,alt:dreambox_player.source.name})}function update_current_recording(){if(!dreambox_player.source)return;let e=$("div.program-info");e.find("h5 span").html(dreambox_player.source.name),e.find("p").html(dreambox_player.source.description),e.find("small.program-now").text("("+moment.duration(dreambox_player.source.duration,"seconds").humanize()+")"),e.find("small.program-next").html("recorded: "+moment(+moment.utc(dreambox_player.source.start)).format("LLLL")+", "+moment.duration(moment(+moment.utc(dreambox_player.source.start))-moment.utc()).humanize(!0)),dreambox_player.source.channel.picon&&e.find("img").attr({src:dreambox_player.source.picon,alt:dreambox_player.source.name})}function update_channel(e){let r=$('a[data-type="channel"][data-id="'+e.id+'"]'),t=null,a=null;null!==e.currentprogram?(t=moment(+moment.utc(e.currentprogram.start)).format("LT"),add_to_epg_refresh_list(moment(+moment.utc(e.currentprogram.stop)),e.id)):add_to_epg_refresh_list(moment.utc(),e.id),e.nextprogram&&(a=moment(+moment.utc(e.nextprogram.start)).format("LT")),r.find("h5").html(e.name),r.find(".program-now span.time").text(t),r.find(".program-next span.time").text(a),null!==e.currentprogram&&r.find(".program-now span.name").html(e.currentprogram.name),null!==e.nextprogram&&r.find(".program-next span.name").html(e.nextprogram.name),r.prev().find(".epg").text("EPG ("+(e.programs_count?e.programs_count:e.programs.length)+")"),e.picon&&r.css("background-image",'url("'+e.picon+'")')}function update_recording(e){let r=$('a[data-type="recording"][data-id="'+e.id+'"]'),t="recorded: "+moment(+moment.utc(e.start)).format("LLLL");r.find("h5").html(e.name),r.find(".program-now").html(t),r.find(".program-next").html("duration: "+moment.duration(e.duration,"seconds").humanize()+", "+moment.duration(moment(+moment.utc(e.start))-moment.utc()).humanize(!0)),null!=e.channel&&e.channel.picon&&""==r.css("background-image")&&r.css("background-image",'url("'+e.channel.picon+'")')}function load_epg(e){if(e&&e.length>0){let r=e.shift(),t=new Date;$.getJSON("/api/dreambox/"+dreambox_id+"/channel/"+r+"/epg",(function(r){r.programs.length>0&&(update_channel(r),refresh_channel_list());let a=new Date-t;a<1e3?setTimeout((function(){load_epg(e)}),1e3-a):setTimeout((function(){load_epg(e)}),100)}))}}function refresh_channel_list(){clearTimeout(channel_refresh_timer);let e=moment().utc().unix(),r=Object.keys(channel_refresh_list).sort();for(var t=0;t<r.length;t++){if(!(r[t]<=e)){channel_refresh_timer=setTimeout((function(){refresh_channel_list()}),1e3*(r[t]-e));break}load_epg(channel_refresh_list[r[t]].slice(0)),delete channel_refresh_list[r[t]]}}function add_to_epg_refresh_list(e,r){let t=e.unix();void 0===channel_refresh_list[t]&&(channel_refresh_list[t]=[]),-1==channel_refresh_list[t].indexOf(r)&&channel_refresh_list[t].push(r)}function load_changelog(e){let r=$("#dreamboxModal");r.find(".modal-dialog").addClass("modal-xl"),r.find(".modal-title").html("CHANGELOG"),r.find(".modal-body img").parent().hide(),r.find(".stream-info").removeClass("col-md-8").html('<h3 class="text-center">Loading changelog ...</h3>'),r.modal(),$.get(e,(function(e){r.find(".stream-info").html("<pre>"+Autolinker.link(e)+"</pre>")}))}function start_progress_bar(){if(null!=dreambox_player.source&&null!=dreambox_player.source.currentprogram){let e=moment.utc()-moment(+moment.utc(dreambox_player.source.currentprogram.start)),r=1e3*dreambox_player.source.currentprogram.duration;$(".progress-bar").css("width",e/r*100+"%")}else $(".progress-bar").css("width","0%")}
